> Данный скрипт предназначен только для образовательных и информационных целей. Авторы не несут ответственности за любой ущерб или убытки, возникшие в результате использования этого кода или его фрагментов. Используйте его на свой страх и риск. Рекомендуем тщательно проверять код перед использованием и не использовать его в производственной среде без тщательного тестирования и оценки его безопасности. Мы не можем гарантировать, что код будет работать без ошибок или отвечать вашим требованиям. Пожалуйста, будьте осторожны.

# Positive Command Line Interface  
#### Версия 24.02.09.1
  
Интерфейс командной строки (CLI) для MaxPatrol API.

- [Запуск и сборка](#id_1)
- [Аргументы и параметры](#id_2)
- [Настройки приложения](#id_3)
- [Интерфейс командной строки](#id_4)
    - [Переменные](#id_4_1)
    - [Простые команды](#id_4_2)
    - [Вспомогательные команды](#id_4_3)
    - [Форматирование вывода](#id_4_4)
    - [Извлечение и сокращение данных](#id_4_5)
    - [Выборка и фильтрация](#id_4_6)
- [Дерево команд MaxPatrol](#id_5)
    - [Работа с профилями подключения API](#id_5_1)
        - [Профили API](#id_5_1_1)
        - [Создание и удаление профилей](#id_5_1_2)
        - [Подключение и отключение](#id_5_1_3)
    - [Работа с коллекторами (AEC)](#id_5_2)
    - [Работа с активами](#id_5_3)
        - [Получение списка](#id_5_3_1)
        - [Быстрый поиск](#id_5_3_2)
        - [Запросы PDQL](#id_5_3_3)
        - [Паспорт](#id_5_3_4)
        - [Выгрузка актива](#id_5_3_5)
        - [Загрузка актива](#id_5_3_6)
        - [Удаление](#id_5_3_7)
        - [Работа с группами активов](#id_5_3_8)
            - [Получение дерева групп](#id_5_3_8_1)
            - [Информация о группе и выгрузка](#id_5_3_8_2)
            - [Импорт групп](#id_5_3_8_3)
            - [Удаление](#id_5_3_8_4)
        - [Работа с запросами активов](#id_5_3_9)
            - [Получение дерева запросов](#id_5_3_9_1)
            - [Информация о запросе и выгрузка](#id_5_3_9_2)
            - [Импорт запросов](#id_5_3_9_3)
            - [Удаление](#id_5_3_9_4)
        - [Работа со сканами активов](#id_5_3_10)
            - [Статистика и список сканов](#id_5_3_10_1)
            - [Получение содержимого сканов](#id_5_3_10_2)
            - [Выгрузка скана](#id_5_3_10_3)
            - [Загрузка скана](#id_5_3_10_4)
        - [Получение списка инфраструктур](#id_5_3_11)
    - [Работа с дашбордами](#id_5_4)
      - [Получение списка](#id_5_4_1)
      - [Получение информации о дашборде и выгрузка](#id_5_4_2)
      - [Загрузка](#id_5_4_3)
      - [Удаление](#id_5_4_4)
    - [Работа с политиками](#id_5_5)
      - [Получение списка](#id_5_5_1)
      - [Получение информации о политике и выгрузка](#id_5_5_2)
      - [Работа с правилами политик](#id_5_5_3)
        - [Изменение положения правила в списке](#id_5_5_3_1)
        - [Создание правил](#id_5_5_3_2)
        - [Удаление](#id_5_5_3_3)
    - [Работа с отчетами](#id_5_6)
        - [Задачи отчетов](#id_5_6_1)
            - [Получение списка](#id_5_6_1_1)
            - [Получение информации о задаче и выгрузка](#id_5_6_1_2)
            - [Загрузка](#id_5_6_1_3)
            - [Удаление](#id_5_6_1_4)
        - [Шаблоны отчетов](#id_5_6_2)
          - [Получение списка](#id_5_6_2_1)
          - [Получение информации о шаблоне и выгрузка](#id_5_6_2_2)
          - [Загрузка](#id_5_6_2_3)
          - [Удаление](#id_5_6_2_4)
    - [Работа с площадками](#id_5_7)
    - [Работа с задачами](#id_5_8)
      - [Получение списка](#id_5_8_1)
      - [Получение информации о задаче и выгрузка](#id_5_8_2)
      - [Загрузка](#id_5_8_3)
      - [Изменение задачи](#id_5_8_4)
      - [Управление задачей](#id_5_8_5)
      - [История выполнения задач](#id_5_8_6)
      - [Удаление](#id_5_8_7)
      - [Работа с учетными записями сканирования](#id_5_8_8)
        - [Получение списка и выгрузка](#id_5_8_8_1)
        - [Загрузка и удаление](#id_5_8_8_2)
      - [Работа с профилями сканирования](#id_5_8_9)
        - [Получение списка и выгрузка](#id_5_8_9_1)
        - [Загрузка и удаление](#id_5_8_9_2)
    - [Работа с шаблонами виджетов](#id_5_9)
        - [Получение списка и выгрузка](#id_5_9_1)
        - [Загрузка и удаление](#id_5_9_2)
    - [Работа с пользователями](#id_5_10)
        - [Сущности пользователей](#id_5_10_1)
        - [Роли пользователей](#id_5_10_2)
    - [Перенос сущностей между разными системами](#id_5_11)
        - [Создание спецификаций](#id_5_11_1)
        - [Загрузка спецификаций](#id_5_11_2)

<div id='id_1'/>

## Запуск и сборка приложения

Вы можете воспользоваться собранной версией CLI для своей операционной системы или, если по каким-то причинам это невозможно, можете запустить непосредственно исходный скрипт, а также собрать исполняемый файл для себя самостоятельно.

*Далее следуют инструкции необходимые для запуска CLI из исходного кода и сборки.*

CLI написан на языке Python и требует версию Python не ниже **3.11**.
Вы можете проверить наличие Python на вашей машине:

```sh
python --version
```

Если Python отсутствует, его необходимо установить и настроить в соответствии с [руководством Python](https://wiki.python.org/moin/BeginnersGuide/Download).

> Для Linux. Если вы хотите, чтобы собранный исполняемый файл работал на системах разных поколений, вы должны осуществить его сборку на самой старой системе. В этом случае, установка Python может отличаться от стандартной. 
Например для Debian 10.13 выглядит следующим образом:
```sh
sudo apt install wget build-essential libncursesw5-dev libssl-dev libsqlite3-dev tk-dev libgdbm-dev libc6-dev libbz2-dev libffi-dev zlib1g-dev
wget https://www.python.org/ftp/python/3.11.4/Python-3.11.4.tgz
tar xzf Python-3.11.4.tgz
cd Python-3.11.4
./configure --prefix=/usr/local --enable-shared LDFLAGS="-Wl,-rpath /usr/local/lib"
make altinstall
python3.11 --version
```


Далее, вам нужно получить копию репозитория, для этого понадобится установленный `git` или вы можете скачать содержимое репозитория вручную:

```sh
cd ~
git clone --branch devel-unstable https://gitlab.ptsecurity.com/vlvlasov/pt-cli.git
cd pt-cli
```

Для того, чтобы не устанавливать зависимости проекта в системный профиль, нужно воспользоваться виртуальным окружением `venv`:

```sh
# Для Windows
python -m venv venv
.\venv\Scripts\activate
# Для Linux
python -m venv venv
source ./venv/bin/activate
# Для Linux с устанвленным пакетом python3.11
python3.11 -m venv venv
source ./venv/bin/activate
```

После того, как мы активировали виртуальное окружение, устанавливаем зависимости проекта:

```sh
pip install -r requirements.txt
```
Теперь вы можете запустить приложение:
```sh
python ./main.py
# Или если Python установлен отдельно
python3.11 ./main.py
```

Для сборки исполняемого файла нужно установить `pyinstaller`:

```sh
pip install pyinstaller
```
Собираем приложение:

```sh
pyinstaller --onefile ./main.py
```
Приложение собрано, исполняемый файл находится в каталоге `./dist`

<div id='id_2'/>

## Аргументы и параметры

При запуске CLI, можно указать глобальное отключение функций, связанных с изменением данных - созданием, обновлением или удалением. Это имеет смысл, когда мы снимаем данные с продуктивной системы.

```sh
pt --disarm
# Или
python ./main.py --disarm
```

В качестве аргумента, исполняемый файл CLI может принять строку команд которую, например, можно вызывать из внешних скриптов. 

>Следует учитывать, что механики профайлов API работать не будут и для подключения нужно использовать сессионное подключение.

```shell
python ./main.py "mp api connect --session --host=127.0.0.1 --login=******* --password=****** && enable && mp task dictionary list"
```

<div id='id_3'/>

## Настройки приложения

PT CLI использует простую локальную базу данных (TinyDB) для хранения различной информации и настроек. TinyDB позволяет хранить и делать запросы к данным, хранящимся в зашифрованном JSON файле. По умолчанию, JSON файл `pt_cli.encrypted` расположен в корне пользовательского каталога системы.

>Данные, которые сохраняются в локальной базе данных и файле истории шифруются на основе пароля, который вводит пользователь при запуске CLI. Восстановить пароль невозможно.

По умолчанию, файл содержащий историю команд `.history` и файл журналирования `pt_cli.log` сохраняются в тот же каталог, из которого запущено приложение. Это можно изменить с помощью команд:

```python
settings set --log_path=Путь
settings set --history_path=Путь
```

Также, можно изменить используемый уровень журналирования (по умолчанию `INFO`) на `DEBUG` или `ERROR`:

```python
settings set --log_level=DEBUG
```

> При нормальном использовании не рекомендуется включать уровень журналирования `DEBUG` (отладка), так как файл журналирования может содержать чувствительную информацию

Посмотреть текущие настройки можно с помощью команды `settings`.

<div id='id_4'/>

## Интерфейс командной строки

Приложение принимает ввод команд, образующих ветвления. Это означает, что различные разделы приложения доступны через определенную последовательность команд. Например, для MaxPatrol основной командой, образующей дерево является команда `mp`, за работу с активами отвечает поддерево `asset`, таким образом команда получения списка активов будет `mp asset list`.

Команды могут принимать общие аргументы (`command argument`) и именованные аргументы (`command argument --keyargument1 --keyargument2=value`). При вводе значений именнованных аргументов, содержащих пробелы, нужно использовать кавычки: `command --keyargument="value with spaces"`.

При передаче аргумента `help`, `?` будет отображаться подсказа для команды. Также, при нажатии `TAB` после ввода команды, будет выведена подсказка по набору субкоманд для данного дерева.

Результат выполнения команд образует контекст, который представляет собой разные структуры данных - список, словарь, строку и т.д. Некоторые команды, такие как `list` имеют встроенные функции обработки результирующего контекста. Т.е. результат этих команд не будет выведен в исходном виде, а предварительно сокращен и обработан, например, для вывода в виде таблицы.

Выполняемые команды могут передавать между собой контекст с использованием PIPE:

```python
command1 | command2
```
Таким образом, результирующий контекст будет передан от первой команды на обработку второй, от второй - третьей и т.д. При передаче контекста между командами, в большинстве случаев встроенные функции обработки игнорируются и структуры данных будут передаваться целиком.

Можно использовать цепочки команд, которые будут выполнены одна за другой:

```sh
command1 && command2 && command3
```
В цепочке команд контекст между ними не передается, однако для взаимодействия между ними можно использовать переменные.

В записи команд можно использовать набор в несколько строк:
```sh
very long command \
command
```

<div id='id_4_1'/>

### Переменные

Переменные в CLI предназначены для удобного хранения различных значений и их последующего повторного использования. Именование переменных представляет собой параметр с особой записью: `$variable_name`, за назначение переменных отвечает вспомогательная комада `set`:

```python
echo "Тест" | set $test
echo $test
set $test="Тестовое значение"
echo $test
```

`set` может быть использован также для назначения выражения в виде цепочки команд:

```python
set $test=$(echo "Тест выражения")
echo $test
```

> При передаче в `set` контекста из другой команды, передаются данные контекста целиком, функции обработки и сокращения опускаются. Т.е. вы можете использовать результат выполненной команды повторно, но сокращения данных в таком случае происходить не будет. Например,  вывод команды `mp task list` представляет собой сокращенный вывод в виде таблицы. Если забрать контекст этой команды в переменную (`mp task list | set $tasks`), то вывод (`echo $test`) будет представлять собой структуру данных представленных в формате `yaml`, однако может быть сокращен и переформатирован другими вспомогательными командами.

<div id='id_4_2'/>

### Простые команды

Простые команды представляют собой команды без особых условий использования. Их основное назначение - базовый функционал приложения и командной строки.

Отобразить помощь:
```sh
help
```
Завершить работу приложения:
```sh
exit
```
Получить версию приложения:
```sh
version
```
Очистить экран:
```sh
cls
```
Получить историю команд:
```sh
history
# Очистить историю
history --clear
```
В некоторых случаях, может быть необходимо повторно использовать результирующий контекст выполненной команды или цепочки команд. В этом случае можно использовать команду `context`:

```sh
mp api list
...
context | select default=true
```
В примере выше, была выполнена команда `mp api list` и отображен результат. Нам понадобилось найти в списке профиль по умолчанию, но без повторного выполнения данной команды. `context` передаст в цепочку финальный контекст предыдущей команды, однако при этом сам приобретет значение результата своей цепочки.

Для того, чтобы вернуться к изначальному контексту, мы можем применить ключ `--last`, тогда будет повторно передан контекст `mp api list`:
```sh
context --last | select api_port==3334
```

Различные значения переменных или просто значения:

```sh
# Вывести строку Тест
echo "Тест"
# Вывести значение переменной $test
echo $test
```

Помимо глобального отключения команд выполняющих передачу данных или изменения в системе, CLI ограничивает их использование, по умолчанию работая в "ограниченном" режиме. Таким образом, при попытке использования таких команд они не сработают и будет выведено соответствующее предупреждение.

Для того, чтобы работать с такими командами, необходимо перейти в "полный" режим:

```sh
enable
```
При этом, рядом со значком `pt` появится отметка режима без ограничений `#`.
Чтобы снова перейти в ограниченный режим:
```sh
disable
```
Для общего импорта данных в систему используется команда `import`, поддерживающая чтение файлов, содержащих JSON и YAML структуры данных. Контекст этой команды может быть передан другим командам:

```sh
import <filename> [--encryption]
```
> Для обеспечения безопасности данных, может быть использовано шифрование. Для того, чтобы импортировать данные выгруженные в зашифрованном виде нужно использовать ключ `--enryption` и перед выполнением команды будет необходимо задать секрет, который был использован при экспорте. 

<div id='id_4_3'/>

### Вспомогательные команды

К вспомогательным командам относятся команды CLI, выполнение которых связано только с работой над контекстом предыдущих команд. Выполнить их вне рамок цепочки PIPE не получится.

Команды простого отбора позволяют взять первое или последнее значение из контекста, если он представляет собой список:

```sh
# Получение первого или первых N позиций списка
... | first [N]
# Получить последний или последние N позиций списка
... | last [N]
```
Получить произвольную позицию из списка можно с помощью `get`:
```sh
... | get --position=N
```
Также, эта команда позволяет извлекать значения тех или иных параметров в структурах данных:
```sh
# Извлечь значения propery_name
... | get --property=property_name
# Извлечь только уникальные значения
... | get --property=propery_name --unique
```
В качестве значения целевого свойства можно использовать пути.
> В MaxPatrol можно встретить именование свойств использующих точку. В этом случае, такие именования необходимо указывать в кавычках, в том числе как элемент пути.

Пример структуры данных:
```json
{
    "top_property1": "value",
    "top_property2": {
        "sub_property1": "value"
    },
    "top.Property3": {
        "sub_property2": "value
    }
}
```
Получение значений:
```sh
... | get --property=top_property1
... | get --property=top_property2.sub_property1
... | get --property='top.Property3'.sub_property2
```

В некоторых случаях, результат выполнения команд может иметь значительную длинну и возникнет необходимость страничного вывода:

```sh
... | more
```

В противоположность простой команде `import`, с помощью `export` можно экспортировать данные в файл. Данная команда используется только в PIPE и передает в файл структуру данных контекста предыдущей команды. При необходимости, данные могут быть защифрованы оригинальным секретом.
```sh
... | export <filename> [--encryption]
``` 
> Указанный при шифровании секрет нужно запомнить, восстановление данных без этого секрета будет невозможным.

<div id='id_4_4'/>

### Форматирование вывода

Как было описано выше, команды формируют свой контекст в зависимости от характера обрабатываемых данных и, в некоторых случаях, функций сокращения. Для отображения контекста используются следующие форматы:

- `TABLE` - отображение в виде таблицы. Структура данных должна представлять собой список. Из позиций, которые в нем содержатся, будут взяты названия ключей верхнего уровня в качестве заголовков колонок и из их значений сформированы строки;
- `CSV` - формат главным образом предназначенный для экспорта. Формируется аналогично `TABLE` и представляет собой вывод в виде заголовков и строк значений, разделенных запятой;
- `JSON` - универсальное представление структур данных в виде JSON;
- `YAML` - универсальное человекочитаемое представление структур данных в виде YAML;

Первая команда в цепочке формирует начальный контекст задавая ему форматирование которое, при возможности, наследуется остальными командами.
Формат контекста может быть изменен с помощью команды `fmt`:

```sh
# format - строка с названием формата: table, json, yaml, csv
... | fmt <format>
```

<div id='id_4_5'/>

### Извлечение и сокращение данных

Многие типовые команды имеют собственные функции сокращения и преобразования полученных данных. Однако могут возникать задачи, связанные с анализом специфических частей и свойств. Также, некоторые данные могут иметь массивную, сложносоставную структуру, например - результат запроса PDQL. 

Для того, чтобы упростить анализ таких данных, а также для решения других задач, связанных с обработкой результатов, можно использовать команду `extract`. Данная вспомогательная команда извлекает из передаваемого контекста значения свойств, описанных в кортеже аргумента:

```sh
... | extract 'property.path1, "property.with.dots".path2, property3'
```
> Кортеж извлекаемых свойств должен быть обязательно помещен в кавычки
Для записи имен свойств, содержащих точку, должны быть также использованы кавычки.

Таким образом, из входящего контекста, например в виде списка, будет образован другой список, содержащий только те свойства, которые перечислены в аргументе `extract`. 

Использование данной функции позволяет формировать различные упрощенные представления данных, для которых такая функция не предусмотрена. В том числе формирование таблиц, CSV выгрузок и т.д.

<div id='id_4_6'/>

### Выборка и фильтрация

При работе с различными данными достаточно часто требуется осуществить поиск какой-либо конкретной информации, которая содержится в этих данных. Это можно сделать с помощью `find`:

```sh
... | find <value>
```
Эта команда осуществляет сквозной поиск указанного значения в структуре данных контекста и возвращает новый контекст с частью структуры, которая их содержит. В основном это может быть применимо для проверки данных на содержание специфического значения или выборки из списков.

В качестве значения `value` можно использовать выражения с `wildcards`, например `find *value`, `find *val*` и т.д.

Так как значительное количество контекса имеет вид списков, необходим инструмент, который позволит осуществлять логическую выборку данных. Данным инструментом является команда `select`:

```sh
... | select <property><logical><value>
mp api list | select name~=noname
```
> Обратите внимение, что логическое выражение записывается без пробелов.

Поддерживаемые операторы сравнения:

- `==` - идентично (равно);
- `!=` - не идентично (не равно);
- `~=` - содержит значение.

Логические операторы:

- `and` - логическое "и";
- `or` - логическое "или".

Группировка логических операторов осуществляется с помощью скобок:
```sh
mp api list | select name~=noname or (front_port==443 and api_port==3334)
```
В итоге выражения выше, будет сформирован новый контекст, содержащий в себе выборку значений списка `mp api list` с значением свойства `name` содержащим слово "noname" или со значениями "front_port" равным 443 и "api_port" равным 3334 одновременно.

>Так как требуется парсинг логических операторов, избегайте пробелов у операторов сравнения (`==` и т.д.). Если в аргументе сравнения есть пробелы, используйте кавычки, т.е. `arg=="arg value"`. Если свойство или часть пути свойства имеет точку, также используйте кавычки, т.е. `"property.with.dot".subproperty==value`.

Если требуется проверить наличие того или иного свойства в объекте, можно использовать значение `null`.

Пример структуры данных:
```json
[
    {
        root_property:
            sub_property_1: "value",
            sub_property_2: "value",
            sub.property_4: "value"
    },
        {
        root_property:
            sub_property_1: "value",
            sub_property_2: "value",
            sub_property_3: "value"
    },
]
```
Необходимо найти только те части списка, в которых есть свойство `root_property.sub_property_3`:
```sh
... | select root_property.sub_property_3!=null
```
Найти только те части, в которых данное свойство отсутствует:
```sh
... | select root_property.sub_property_3==null
```
Найти части имеющие заданное значение с именем свойства, содержащим точку:
```sh
... | select root_property."sub.property_4"==value
```

<div id='id_5'/>

## Дерево команд MaxPatrol

Функции и команды, связанные с работой MaxPatrol, собраны в дерево команд `mp`. 

Общая структура команд этого дерева выглядит следующим образом:
```yaml
mp: # Высший уровень дерева MaxPatrol
    aec # Работа с коллекторами
    api # Работа с профилями подключения API
    asset: # Работа с активами
        group # Работа с группами активов
        query # Работа с запросами активов
        scan # Работа со сканами активов
        scope # Работа с инфраструктурой
    dashboard # Работа с дашбордами
    policy: # Работа с политиками
        rule # Работа с правилами политик
    report: # Работа с отчетами
        task # Работа с задачами отчетов
        template # Работа с шаблонами отчетов
    site # Работа с площадками
    task: # Работа с задачами
        credential # Работа с учетными записями задач
        dictionary # Работа со списками
        profile # Работа с профилями сканирования
    template # Работа с шаблонами виджетов
    user: # Работа с пользователями MC
        role # Работа с ролями пользователей MC

```
>Практически все команды и структуры команд для своей работы требуют подключения к API MaxPatrol.

В высшем уровне команд дерева вы можете получить информацию о системе к которой в данный момент подключены:
```sh
mp info
```
Также, здесь же находится универсальная команда импорта спецификаций CLI:
```sh
mp import <filename>
```
Данную команду можно использовать для пакетного импорта спецификаций (указав, например, префикс файлов спецификаций со звездочкой - pt*.yaml) или как универсальную команду импорта и создания сущностей из спецификаций.

В случае пакетного импорта, команда сама определяет правильный порядок загрузки сущностей для правильного построения взаимосвязей.

<div id='id_5_1'/>

## Работа с профилями подключения API

Выполнение команд дерева MaxPatrol связано с запросами к программному интерфейсу API и требует подключения к нему.
Поддерево `mp api` отвечает за осуществление подключения и работу с сохраненными профилями подключений.

В CLI поключиться к API MaxPatrol можно двумя путями - с получением токена на предъявителя (Bearer token) и с использованием сессии пользователя. 

> Следует отметить, что несмортя на удобство сессионного подключения, некоторые функции и команды могут работать некорректно или не работать вообще. Подключение через токен является предпочтительным.

<div id='id_5_1_1'/>

### Профили API

Для удобства работы с несколькими API в CLI существует механизм работы с сохраненными профилями подключения.

Получить список существующих профилей можно с помощью команды `list`:
```sh
mp api list
```
Также, можно получить более расширенную информацию о профилях или конкретном профиле и экспотрировать ее в спецификацию для переноса в другую систему:
```sh
# Получение информации о профиле name
mp api info <name>
# Получение информации о всех профилях системы
mp api list | mp api info
# Создание спецификации всех профилей
mp api list | mp api info | export api_profiles.yaml
```
<div id='id_5_1_2'/>

### Создание и удаление профилей

Создать новый профиль подключения можно с помощью диалога:
```sh
mp api create
# Запуск в тестовом режиме
mp api create --disarm
```
Или с использованием именованных аргументов:
```sh
mp api create --name=<имя_профиля> --host=<FQDN/IP> --secret=<MP client_secret> --api_port=<порт MP API> --front_port=<порт MP Frontend> --default=<True>
```
Указание `secret`, `api_port`, `front_port`, `default` не является  обязательным.

> Для подключения с помощью токена требуется указание client_secret, которое можно получить для Windows систем c помощью `corecfg get -p ClientSecret`, для Linux систем из конфигурации с помощью `sudo grep ClientSecret /var/lib/deployer/role_instances/core*/params.yaml`

Также профили могут быть созданы из ранее сохраненной спецификации:
```sh
import api_profiles.yaml | mp api create
```
Удалить профиль или профили можно с помощью команды `delete`:
```sh
# Удаление профиля name
mp api delete <name>
# Удаление всех профилей
mp api list | mp api delete
# Запуск в тестовом режиме
mp api delete <name> --disarm
```

<div id='id_5_1_3'/>

### Подключение и отключение

Для быстрого подключения к программному интерфейсу можно использовать сессионный способ подключения, в котором требуется только учетная запись пользователя:

```sh
mp api connect --session --host=<IP/FQDN> --login=<name> --password=<password>
```

Подключение с помощью сохраненного профиля:
```sh
# Подключение с использованием профиля и диалога
mp api connect <profile_name>
# Подключение с использованием профиля и параметрами
mp api connect <profile_name> --login=<login> --password=<password>
# Подключение с использованием профиля сессией
mp api connect <profile_name> --session
```
В случае успешного подключения, в левой части заголовка CLI будет отражен сервер к которому мы в данный момент подключены.

Отключиться от системы можно с помощью команды:
```sh
mp api disconnect
```

<div id='id_5_2'/>

## Работа с коллекторами (AEC)

Работа с коллекторами (AEC) на данный момент ограничена возможностью получения их списка и информации коллекторе:

```sh
# Получение списка коллекторов
mp aec list
# Получить статус всех коллекторов
mp aec list | extract 'name, status' | fmt table
# Получение информации о конкретном коллекторе
mp aec info <aec_name | aec_id>
# Получение информации о всех коллекторах в системе
mp aec list | mp aec info
```

<div id='id_5_3'/>

## Работа с активами

Работа с активами и связанными сущностями осуществляется с помощью поддерева `mp asset`. Полная структура поддерева выглядит следующим образом:
```yaml
mp:
    asset:
        delete # Удаление актива
        dump # Сохранение конфигурации актива
        group:
            create # Создание групп активов
            delete # Удаление групп активов
            info # Информация о группе активов
            list # Получение списка групп активов
        list # Получение упрощенного списка активов
        load # Загрузка спецификации актива
        passport # Получение паспорта актива
        pdql # Запуск запроса PDQL
        search # Поиск активов
        query:
            create # Создание запросов активов
            delete # Удаление запросов активов
            info # Информация о запросе активов
            list # Получение списка запросов активов
        scan:
            content # Получение содержимого сканов
            dump # Сохранение скана
            list # Получение списка сканов
            stat # Статистика по сканам в системе
        scope # Получение списка инфраструктур
```
<div id='id_5_3_1'/>

### Получение списка

Активы являются одной из основых сущностей MaxPatrol. Как отдельный объект, они могут содержать в себе абсолютно различную информацию в зависимости от типа актива, качества сканирования и других факторов. Тем не менее, у активов есть ряд общих обязательных аттрибутов (параметров).

Получить упрощенный список активов можно c помощью команды `list`:
```sh
mp asset list
```
Данная команда фактически делает запрос PDQL `select(@Host, Host.IpAddress, Host.OsName, Host.@CreationTime, Host.@UpdateTime) | sort(@Host ASC)`, получает список активов с элементарным набором параметров, сокращает его и представляет в табличном виде.

Следует учитывать, что количество активов в системе может быть значительным и список по умолчанию лимитирован до 50. Вы можете сдвигать список относительно начала с помощью параметра `--offset=N` и управлять размером списка с помощью `--limit=N`.
Также, можно вызвать выбор группы для фильтрации с помощью параметра `--group`.

``` python
#Получить список активов, в которых определена операционная система
mp asset list --offset=0 --limit=100 --group | select 'host.osname'!=none
```

>Как и в других структурах, для выборки вы можете использовать имена свойств. Следует отметить, что в активах, как и в результатах PDQL приходят свойства содержащие в имени точку. Эти свойства нужно использовать в кавычках: `'property.with.dot'.subproperty`

Пример структуры актива, возвращаемого командой `list`:
```yaml
- '@Host':
    name: host.demo.local (192.168.1.1)
    id: 19da7d2f-f900-0001-0000-000000000009
    deviceType: Workstation
    type: OperatingSystem.Windows.WindowsHost
    displayTime: null
    version: '4'
  Host.IpAddress: 192.168.1.1
  Host.OsName: Windows 10
  Host.@CreationTime: '2024-01-28T17:34:26Z'
  Host.@UpdateTime: '2024-01-28T17:34:26Z'
```

<div id='id_5_3_2'/>

### Быстрый поиск

Работать со списком активов не всегда удобно, особенно при их большом количестве. К счастью, в MaxPatrol есть функция быстрого поиска активов - PDQL `qsearch()`. 

С помощью команды `search` можно запустить функцию быстрого поиска и найти интересующие активы по имени или адресу:

```sh
mp asset search <data>
```

В этой команде, также как и в `list`применяются параметры `offset`, `limit` и `group`. Обработка и сокращение данных также аналогичны.

<div id='id_5_3_3'/>

### Запросы PDQL

Запросы PDQL являются одним из основных средств работы с данными в системе MaxPatrol. С их помощью можно осуществлять поиск специфических активов, получать срезы данных по интересующим параметрам и многие другие действия, связанные с данными в системе.
PDQL запросы формируются в виде строки запроса, содержащей необходимое выражение выборки, выражение сортировки, группировки и аггрегации, а также фильтрации.

```sh
mp asset pdql `select(@Host, Host.@Id, host.IpAddress, Host.OsName, Host.@CreationTime, Host.@UpdateTime) | sort(@Host ASC)`
```

>Обратите внимание, что запрос PDQL **всегда** передается в кавычках

Результаты PDQL запросов могут быть очень массивными и обильными с точки зрения содержащихся данных. Для каких-либо типовых запросов можно подготовить `extract` таким образом, чтобы осуществлялось формирование только нужных полей, например:

```sh
mp asset pdql 'select(@Host, Host.@Vulners, Host.@Vulners.DiscoveryTime, Host.@Vulners.Status, Host.@Vulners.FixType, Host.@Vulners.IsDanger, Host.@Vulners.Tags) | filter(Host.@Vulners)' | extract '@Host.name, "Host.@Vulners".kb, "Host.@Vulners".severityRating' | fmt table
```

В результате, будет выведена таблица с колонками `@Host.name`, `Host.@Vulners".kb`, `"Host.@Vulners".severityRating`.

<div id='id_5_3_4'/>

### Паспорт

Каждый актив имеет хорошо известный по UI паспорт, который отражает основные данные по активу. Получить его можно следующим образом:

```
mp asset passport <name | ID>
```
Пример структуры паспорта актива:
```yaml
- assetId: 19da7d2f-f900-0001-0000-000000000009
  userAssetName: null
  defaultAssetName: host.demo.local (192.168.1.1)
  description: null
  metrics:
  - type: AR
    id: ND
    effectiveValueId: ND
  - type: CDP
    id: ND
    effectiveValueId: ND
  - type: CR
    id: ND
    effectiveValueId: ND
  - type: IR
    id: ND
    effectiveValueId: ND
  - type: TD
    id: ND
    effectiveValueId: ND
  importance:
    unmanaged: []
    managedByUser: []
    managedBySystem:
    - policyId: assetImportance
      ruleId: 19ba5980-db40-0001-0000-00000000055f
      ruleName: Policy_1
      assets:
      - 19da7d2f-f900-0001-0000-000000000009
    value:
      type: core.assetsInfo.importance
      value: L
  scanningIntervals:
    audit: null
    pentest: null
  useTtl: true
```
По умолчанию, команда сокращает данную структуру и преобразует ее возвращает ее в табличном формате.

Пример получения паспорта первого актива в списке и его представление в формате `YAML`:
```sh
mp asset list | first | mp asset passport | fmt yaml
```

<div id='id_5_3_5'/>

### Выгрузка актива

> Для того, чтобы была возможность выгрузить активы, должен быть доступен нестандартный порт MP Core `8723`. 
> Не работает при подключении с помощью сессии.

Процесс выгрузки актива и информации об его конфигурации представляет собой фактически экспорт сырых данных и значительно отличается от простого экспорта описаний других сущностей. Поэтому процесс выгрузки этой информации осуществляется непосредственно из дерева `mp asset` без использования команды `export`, а загрузка - специальной командой `load` вместо связки `import`->`create`.

Упрощенно процесс выглядит так:
- Формируется и тестируется выборка нужных активов;
- Выборка отправляется в `mp asset dump`.

```sh
# Команда выгрузки актива в общем виде
... | mp asset dump <filename.yaml>
# Пример выгрузки первого актива из списка
mp asset list | first | mp asset dump <filename.yaml>
```

>Важно: при большом количестве активов будте осторожны с выгрузкой, формирование спецификаций занимает значительное количество ресурсов по памяти и диску. Оптимальным будет выгрузка активов частями.

Эта команда сохраняет только текущую конфигурацию актива, доступную на момент ее выполнения.
В случае необходимости, можно выгружать спецификации в зашифрованном видет с ключом `--encryption`.

<div id='id_5_3_6'/>

### Загрузка актива

> Зависимости: отсутствуют.

По своей сути, загрузка актива или активов представляет собой загрузку в систему нового скана типа `audit` с датой и временем соответствующим времени загрузки. Таким образом, если актив до этого отсутствовал в системе, после процессинга он должен будет появится как новый актив с временем последнего скана аудитом равным времени загрузки. Если актив присутсвует в системе, к нему добавится новый аудит.

Так как экспортируемая информация является фактически "слепком" с актива в исходной системе, то будут перенесены все проблемы этого актива, если они присутствуют.

```sh
# Команда загрузки актива в общем виде
mp asset load <filename.yaml>
# С использованием шифрования
mp asset load <filename.encrypted> --encryption
```

> Блоки активов не загружаются с помощью команды `mp import`

<div id='id_5_3_7'/>

### Удаление

Удалить актив или активы можно с помощью команды `delete`:
```sh
# Удаление актива name
mp asset delete <name>
# Удаление активов из группы
mp asset list --group | mp asset delete
# Запуск в тестовом режиме
mp asset delete <name> --disarm
```

<div id='id_5_3_8'/>

### Работа с группами активов

В MaxPatrol группы бывают двух видов - статические, формируемые вручную и динамические, формируемые с помощью фильтров. При этом, статические группы могут служить своеобразными каталогами для набора динамических групп.

В целом, структура групп активов представляет собой иерархическую древовидную структуру, где дочерние группы вложены в родительскую. Вершиной иерархии является группа `Root`:

```yaml
- id: 00000000-0000-0000-0000-000000000002
  name: Root
  groupType: static
  children:
  - id: 19d785d6-7b00-0001-0000-000000000005
    name: Top Folder
    groupType: static
    children:
    - id: 19d785d9-b0c0-0001-0000-000000000009
      name: Dynamic Group
      groupType: dynamic
    - id: 19d785dc-e040-0001-0000-00000000000d
      name: Static Group
      groupType: static
```

<div id='id_5_3_8_1'/>

#### Получение дерева групп

Для дерева групп, команда `list` осуществляет упрощение представления данных и возвращает контекст в древовидном формате `TREE`. 

```sh
mp asset group list
```

К сожалению,  выборка из древовидной структуры недоступна, однако дерево групп можно сократить, задав как аргумент имя группы относительно которой выполнить построение дерева. То есть, из примера выше, мы можем потобразить дерево начиная с группы `Top Folder`:

```sh
mp asset group list Top Folder
```

<div id='id_5_3_8_2'/>

#### Информация о группе и выгрузка

Получить полную информацию о той или иной группе можно с помощью команды `info`. Информация предоставляемая данной командой достаточна для описания группы и может быть сохранена в спецификацию, которую позже можно импортировать.

```sh
# Команда получения информации в общем виде
mp asset group info <name | ID>
# Получение информации о группах на основе списка
mp asset group list | mp asset group info
# Выгрузка спецификации групп
mp asset group list | mp asset group info | export filename.yaml
```

Пример структуры информации о группе:

```yaml
- id: 19dc863a-0d40-0001-0000-000000000021                               
  parentId: 19dc8627-2900-0001-0000-000000000009
  name: Group
  description: null
  predicate: Host.HostRoles.Role = 'Database Server'
  isDeleted: false
  isReadOnly: false
  isSlow: false
  groupType: dynamic
  metrics:
    ar: ND
    cdp: ND
    cr: ND
    ir: ND
    td: ND
  organizationInformation:
    contactUserId: null
    address: null
  organizationInfrastructure:
    usedNetworks: null
    numberOfNodes: null
    usedNetworkApplications: null
    internetProviders: null
    registeredDomains: null
  cli-mixin:
    mixin_ref_version: '2'
    kind: group
    timestamp: '2024-01-30 21:15:14.228301'
    product: 26.1.8760
    references_id:
    - id: 19dc8627-2900-0001-0000-000000000009
      kind: group
      hierarchy:
      - Root
      - Demo
      - Инфраструктурная роль
    parentName: Инфраструктурная роль
    hierarchy:
    - Root
    - Demo
    - Инфраструктурная роль
    - Group
```
К каждой выгрузке расширенной информации CLI добавляет "примесь" в которой сохраняет информацию, необходимую для последующего импорта сущности.

В примере выше, "примесь" содержит описание родительской группы и развернутую иерархию для определения положения группы. 

>Важно: Членство активов в статических группах не хранится в сущности самой группы, а сохраняется непосредственно в активе. Таким образом, при переносе такой группы и отсутствии соответствующих активов в другой системе, содержимое такой группы будет утеряно и потребует ручного восстановления.

<div id='id_5_3_8_3'/>

#### Импорт групп
> Зависимости: Вышестоящие в иерархии группы активов.

Получив спецификацию, как в примере выше, ее можно импортировать в систему:

```sh
# Запуск в режиме тестирования
import filename.yaml | mp asset group create --disarm
# Импорт
import filename.yaml | mp asset group create
```

CLI будет пытаться создать группу отностительно той иерархии, которая описана в "примеси" в свойстве `hierarchy`. Соответственно отсутствие вышестоящих групп может привести к тому, что импорт завершится ошибкой.

>На данный момент в команде нет опции по изменению относительного расположение группы, однако в случае необходимости вы можете исправить `hierarchy` на требуемую и успешно импортировать группу.

<div id='id_5_3_8_4'/>

#### Удаление

Удаление может быть осуществлено как по имени или ID, так и по списку переданному в контексте. При удалении вышестоящей группы, все дочерние группы будут так же удалены.

```sh
# Запуск в режиме тестирования
mp asset group delete <name | ID> --disarm
# Удаление группы
mp asset group delete
# Удаление списка групп
mp asset group list | mp asset group delete
```
> Чтобы удалить группу в "тихом" режиме без дополнительного продтверждения, можно использовать ключ `--quiet`.

<div id='id_5_3_9'/>

### Работа с запросами активов

Аналогично группам, запросы активов в MaxPatrol представляют собой древовидную структуру. Однако они имеют определенные особенности:

- Запросы разделяются на встроенные (Стандартные запросы), общие пользовательские запросы (Общие запросы) и запросы пользователя (Пользовательские запросы). При этом, те запросы, которые находятся в последнем вышестоящем разделе, доступны только в текущем контексте пользователя в системе;
- Существует определенный вид запросов со свойством `isFolder`, которые являются по сути каталогами в иерархической структуре.

Пример иерархии запросов:
```yaml
- children: null
  id: 3b62135583844fc58dde59101b218a01
  displayName: Все активы
  isFolder: false
  parentId: null
  type: standard
  tree_hierarchy:
  - Все активы
- children:
  - children: null
    id: e1acccddff5f4743b0905439e6b7bd1e
    displayName: Последние созданные
    isFolder: false
    parentId: 0d1fa9e8d92c4d9ba1654c5c3cb9ac71
    type: standard
    tree_hierarchy:
      - Стандартные запросы
      - Последние созданные
- children: null
  id: CommonRootFolder
  displayName: Общие запросы
  isFolder: true
  parentId: null
  type: common
  tree_hierarchy:
  - Общие запросы
- children: null
  id: ea5d4afd-e352-4087-9c40-93d7ac0e6ac8_root
  displayName: Пользовательские запросы
  isFolder: true
  parentId: null
  type: user
  tree_hierarchy:
  - Пользовательские запросы
```

<div id='id_5_3_9_1'/>

#### Получение дерева запросов

Для дерева запросов, команда `list` также осуществляет упрощение представления данных и возвращает контекст в древовидном формате `TREE`, аналогично группам запросов. Здесь действуют такие же механизмы и ограничения (отсутствие выборки):

```sh
# Получение всего дерева запросов
mp asset query list
# Получение дерева общих запросов 
mp asset query list Общие запросы
# Получение только пользовательских (нестандартных) запросов
mp asset query list --user_only
```

<div id='id_5_3_9_2'/>

#### Информация о запросе и выгрузка

Пример выше показывает, что общая иерархия запросов несет в себе относительно мало информации о том, что делает тот или иной запрос. Команда `info` позволяет получить данную информацию и сформировать спецификацию запроса для дальнейшего использования.

```sh
# Команда получения информации в общем виде
mp asset query info <name | ID>
# Получение информации о пользовательских запросах на основе списка
mp asset query list --user_only | mp asset query info
# Выгрузка спецификации пользовательских групп
mp asset query list --user_only | mp asset query info | export filename.yaml
```

Пример структуры информации о запросе:

```yaml
- id: 8caa68ee48d74adfb12adbdd169e0ea3
  displayName: Критичные уязвимости
  folderId: ea5d4afd-e352-4087-9c40-93d7ac0e6ac8_root
  filterId: null
  filterPdql: null
  selectionId: null
  selectionPdql: select(@Host, host.@vulners.SeverityRating) | filter(host.@vulners.SeverityRating
    !=null  and host.@vulners.SeverityRating != "none") | sort(host.@vulners.SeverityRating
    DESC) | group(host.@vulners.SeverityRating, COUNT(*))
  isInvalid: false
  isDeleted: false
  type: user
  isFolder: false
  cli-mixin:
    mixin_ref_version: '2'
    kind: query
    timestamp: '2024-01-31 19:35:55.824362'
    product: 26.1.8760
    hierarchy:
    - Пользовательские запросы
    - Критичные уязвимости
    references_id:
    - id: ea5d4afd-e352-4087-9c40-93d7ac0e6ac8_root
      kind: query
      hierarchy:
      - Пользовательские запросы
```

CLI будет пытаться создать запрос отностительно той иерархии, которая описана в "примеси" в свойстве `hierarchy`. Соответственно отсутствие вышестоящих каталогов может привести к тому, что импорт завершится ошибкой.

>На данный момент в команде нет опции по изменению относительного расположение запроса, однако в случае необходимости вы можете исправить `hierarchy` на требуемую и успешно импортировать запрос.

<div id='id_5_3_9_3'/>

#### Импорт запроса

> Зависимости: вышестоящие каталоги запросов.

Получив спецификацию, как в примере выше, ее можно импортировать в систему:

```sh
# Запуск в режиме тестирования
import filename.yaml | mp asset query create --disarm
# Импорт
import filename.yaml | mp asset query create
```

CLI будет пытаться создать запрос отностительно той иерархии, которая описана в свойстве `tree_hieracrchy`. Соответственно отсутствие вышестоящих каталогов может привести к тому, что импорт завершится ошибкой.

>На данный момент в команде нет опции по изменению относительного расположения запроса, однако в случае необходимости вы можете исправить `tree_hierarchy` на требуемую и успешно импортировать запрос.

<div id='id_5_3_9_4'/>

#### Удаление

Удаление может быть осуществлено как по имени или ID, так и по списку переданному в контексте. При удалении каталога, все дочерние запросы будут так же удалены.

```sh
# Запуск в режиме тестирования
mp asset query delete <name | ID> --disarm
# Удаление группы
mp asset query delete
# Удаление списка групп
mp asset query list | mp asset query delete
```
> Чтобы удалить запрос в "тихом" режиме без дополнительного продтверждения, можно использовать ключ `--quiet`.

<div id='id_5_3_10'/>

### Работа со сканами активов

В результате выполнения задач сканирования на коллекторах (AEC) образуются блоки данных, которые передаются в ядро системы для дальнейшей обработки, нормализации и обогащения информации об активах. Такие блоки условно называются "сканами" и также храняться в системе в двух видах - "сырые" и "обработанные" сканы.

> Блоки данных сканов нельзя удалить из системы.

Сканы бывают разных видов, в зависимости от типа задачи в результате которой они образовались и несут в себе различную информацию о том или ином активе. 


 <div id='id_5_3_10_1'/>

#### Статистика и список сканов

Для того, чтобы быстро оценить какие виды сканов и в каком количестве имеются в системе в интересующий отрезок времени:

```sh
# Получение статистики по сканам за последние 28 дней
mp asset scan stat
# Получение статистики по сканам за последние N дней
mp asset scan stat --for_last_days=N
# Получение статистики по сканам начиная с даты YYYY-MM-DD
mp asset scan stat --from_date=YYYY-MM-DD
# Получение статистики с ограничением количества
mp asset scan stat --limit=N
# Получение статистики по сырым сканам
mp asset scan stat --raw
```

 >В зависимости от установленных политик, данные активов устаревают в определенные сроки. Таким образом сканы, которые получены ранее установленных сроков устаревания не имеют информативной ценности. Проверить, какие сроки установлены политиками можно с помощью команды `mp policy info auditScanningInterval | get --property=actionResult.obsoletePeriod`. Получив максимальный срок устаревания, можно указать его в ключе `--for_last_days` 

 Количество сканов может быть очень большим, поэтому работу с ними лучше осуществлять небольшими блоками. Блок можно сохранить в переменную и работать с уже полученными данными:

 ```sh
 # Получение списка обработанных сканов за последние 28 дней
 mp asset scan list
 # Получение списка сырых сканов 
 mp asset scan list --raw
 # Получение списка сканов за последний день
 mp asset scan list --for_last_days=1
 # Получение списка сканов начиная с определенной даты
 mp asset scan list --from_date=2024-01-30
 # Получение списка сканов, не прошедших обработку
 mp asset scan list --unprocessed
 ```

 > По умолчанию, команда `list` возвращает список сканов за последние 28 дней.

 Пример структуры списка сканов:
 ```yaml
 - type: ScanInfo
  isValid: true
  orderedId: 124
  id: c9890aef-83bc-424e-aa33-a668425bc0ad
  timeStamp: '2024-01-30T13:09:56.0178930Z'
  source: Audit
  scopeId: 00000000-0000-0000-0000-000000000005
  jobId: null
  noTtl: false
  replaceEntities: false
  createOnly: false
 ```

  <div id='id_5_3_10_2'/>

#### Получение содержимого сканов

Содержимое сканов представляет собой XML структуру в формате `bytes`. В этой структуре содержится информация, полученная в результате выполнения задачи сканирования актива:

```sh
# Получение содержимого скана по ID
mp asset scan content <ID скана>
# Получение содержимого сырого скана по ID
mp asset scan content <ID скана> --raw
# Получение содержимого нескольких сканов
mp asset scan list --limit=3 | mp asset scan content
# Извлечение свойств содержимого скана
mp asset scan list --limit=3 | mp asset scan content | extract 'content.Snapshot.Base.ns0:Host.@Id, content.Snapshot.Base.ns0:Host.IpAddress' | fmt table
```

  <div id='id_5_3_10_3'/>

#### Выгрузка скана

Процесс выгрузки сканов представляет собой фактически экспорт сырых данных и значительно отличается от простого экспорта описаний других сущностей. Поэтому процесс выгрузки этой информации осуществляется непосредственно из дерева `mp asset scan` без использования команды `export`, а загрузка - специальной командой `load` вместо связки `import`->`create`.

```sh
# Команда выгрузки скана в общем виде
mp asset scan dump [--encryption]
# Выгрузка сканов за один день
mp asset scan list --for_last_days=1 | mp asset scan dump filename.yaml
# Выгрузка только сканов аудита
mp asset scan list --for_last_days=1 | select source==audit | mp asset scan dump filename.yaml
```
Для выгрузки скана в зашифрованном виде можено использовать ключ `--encrypted`.
> Блоки сканов не загружаются с помощью команды `mp import`

  <div id='id_5_3_10_4'/>

#### Загрузка скана

> Зависимости: отсутствуют.

Процессинг активов устроен таким образом, что обрабатываются только новые по времени сканы. Таким образом, загрузка и последующая обработка блока скана возможна только если она последняя в списке сканов системы. Чтобы реализовать эту особенность, CLI подставляет в качестве отметки времени скана штамп текущего времени.

Это приведет к тому, что данные, которые содержатся в скане, будут восприняты системой как скан, который прошел только что.

```sh
# Команда загрузки скана в общем виде
mp asset scan load <filename.yaml>
# Запуск в тестовом режиме
mp asset scan load <filename.yaml> --disarm
# С использованием шифрования
mp asset scan load <filename.encrypted> --encryption
```

<div id='id_5_3_11'/>

### Получение списка инфраструктур

В некоторых сущностях MaxPatrol используется идентификатор инфраструктуры. Для систем, в которых их несколько, список инфраструктур можно получить с помощью команды `scope`:

```sh
mp asset scope
```

Пример структуры данных инфраструктуры:
```yaml
- id: 00000000-0000-0000-0000-000000000005
  name: Инфраструктура по умолчанию
  tenantId: a5ec6def-dd40-4548-aa76-b3aacfe6cec7
```

<div id='id_5_4'/>

## Работа с дашбордами

Дашборды или страницы в MaxPatrol используются для визуализации данных на основной странице UI и представляют собой набор блоков, расположенных в виде преопределенной сетки. Блоки содержат в себе различные данные по структуре данных, фильтрации, запросам и форматированию.

Работа с дашбордами осуществляется с помощью поддерева `mp dashboard`. Полная структура поддерева выглядит следующим образом:
```yaml
mp:
    dashboard:
      create # Создание дашбордов
      delete # Удаление
      info # Получение информации о дашборде
      list # Получение списка
```

<div id='id_5_4_1'/>

### Получение списка

Получить список дашбордов (страниц) можно с помощью команды `list`:

```sh
mp dashboard list
```
Пример структуры данных списка:
```yaml
- id: 1
  version: 0
  name: Пользовательский дашборд
  description: null
  isDeletable: true
  isResetable: false
  isLocalized: false
  isLocked: false
  canAddNewWidget: true
```
Список позволяет получить очень общие данные о тех дашбордах, которые присутствуют в системе. К сожалению, здесь отсутствует какое-либо свойство для определения является ли сущность системной или пользовательской.

<div id='id_5_4_2'/>

### Получение информации о дашборде и выгрузка

Получить полную информацию о той или иной странице (дашборде) можно с помощью команды `info`. Информация предоставляемая данной командой достаточна для описания и может быть сохранена в спецификацию, которую позже можно импортировать.

```sh
# Команда получения информации в общем виде
mp dashboard info <name | ID>
# Получение информации о дашбордах на основе списка
mp dashboard list | mp dashboard info
# Выгрузка спецификации дашбордов
mp dashboard list | mp dashboard info export filename.yaml
```
Пример структуры данных дашборда:
```yaml
- id: 1
  version: 0
  name: API Test
  description: null
  position: 0
  isDeletable: true
  isResetable: false
  isLocalized: false
  isLocked: false
  canAddNewWidget: true
  ownerId: ea5d4afd-e352-4087-9c40-93d7ac0e6ac8
  layout:
    structure: flex-dashboard
  widgets:
  - type: WidgetByDataFilter
    filter:
      type: qualityChecks
      refresh: null
    source:
    - service
    systemTemplateId: null
    name: Проверки по чек-листу
    settings: null
    layoutType: ptBarChart
    refreshCachingPolicy:
      type: periodical
      interval:
        value: 15mi
    id: 1
    version: 1
    system: true
    layoutSettings:
      index: 1
      styleClass: null
    dataMeta: null
  cli-mixin:
    mixin_ref_version: '2'
    kind: dashboard
    timestamp: '2024-01-19 08:44:07.927072'
    product: 26.1.8760
    references_id:
    - id: ea5d4afd-e352-4087-9c40-93d7ac0e6ac8
      kind: user
      user_login: Administrator
```

В примере выше можно увидеть, что данные дашборда содержат в себе ссылки в виде ID на различные сущности - пользователей,  группы и запросы. При формировании информации CLI сохранит дополнительные свойства этих сущностей в "примеси" для возможности их определения в другой системе.

<div id='id_5_4_3'/>

### Загрузка

> Зависимости: группы и запросы активов, пользователи.

Для того, чтобы загрузка спецификации дашборда прошла успешно, все сущности внутри его спецификации должны быть разрешены в ID, которые присутствуют в системе. Таким образом есть два основных варианта загрузки:

- Перед загрузкой дашборда или нескольких дашбордов, осуществить импорт соответствующих запросов, групп и пользователей;
- Попытаться импортировать дашборд и преобразовать отсутствующие сущности.

```sh
# Запуск в режиме тестирования
import filename.yaml | mp dashboard create --disarm
# Импорт
import filename.yaml | mp dashboard create
```

<div id='id_5_4_4'/>

### Удаление

Удалить дашбоард или дашборды можно с помощью команды `delete`:
```sh
# Удаление дашборда name
mp dashboard delete <name>
# Удаление всех дашбордов
mp dashboard list | mp dashboard delete
# Запуск в тестовом режиме
mp dashboard delete <name> --disarm
```

<div id='id_5_5'/>

## Работа с политиками

В MaxPatrol политики являются совокупностью правил, с помощью которых можно осуществлять автоматизацию некоторых процессов - например процессов устранения уязвимосте и регулярность сканирования активов. Политики разделяются на разные типы и содержат в себе правила политик.

Работа с политиками осуществляется с помощью поддерева `mp policy`. Полная структура поддерева выглядит следующим образом:
```yaml
mp:
    policy:
      info # Получение информации о политиках
      list # Получение списка
      rule: # Получение информации о правиле
        bottom # Перенос правила вниз списка
        create # Создание правил политик
        delete # Удаление
        down # Перемещение правила ниже в списке
        top # Перенос правила вверх списка
        up # Перемещение правила выше в списке
```
>Политики сами по себе нельзя удалить или создать, однако могут быть созданы различные правила политик.

<div id='id_5_5_1'/>

### Получение списка

Получить список политик можно с помощью команды `list`:

```sh
mp policy list
```
Пример структуры данных списка:
```yaml
- policyId: auditScanningInterval
  isRecalculatingNow: false
  lastDateOfRecalculation: '2024-01-31T22:32:46.8053320Z'
  isValid: true
  isDraftValid: true
  hasChanges: false
  rules_count: 2
  rule_ids:
  - 19aabbc1-7f80-b001-0000-000000000003
  - 19aabbc1-7400-b001-0000-000000000002
  rule_names:
  - Сроки актуальности активов средней значимости для метода Audit
  - Сроки актуальности активов высокой значимости для метода Audit
```
Присутствие в списке различных значений `policyID` может варьироваться в зависимости от состава компонентов системы. Сами по себе сущности политик содержат в себе список идентификаторов правил, которые определяют действие политики.

<div id='id_5_5_2'/>

### Получение информации о политике и выгрузка

Так как политики являются по сути фиксированными сущностями, информация по ним представляет собой совокупную выгрузку правил политики. Сделать ее можно с помощью `info`. Информация предоставляемая данной командой достаточна для описания и может быть сохранена в спецификацию, которую позже можно импортировать.

```sh
# Команда получения информации в общем виде
mp policy info <name | ID>
# Получение информации о политиках на основе списка
mp policy list | mp policy info
# Получение правил для конкретной политики
mp policy info auditScanningInterval | fmt table
# Выгрузка спецификации политик
mp policy list | mp policy info export filename.yaml
```
Пример структуры данных политики:
```yaml
- id: 19aabbc1-7f80-b001-0000-000000000003
  precedingRuleId: null
  name: Сроки актуальности активов средней значимости для метода Audit
  condition:
    type: PolicyRuleAssetCondition
    groupsList:
    - 00000000-0000-0000-0000-000000000002
    assetFilter: Host.@Importance = 'M'
  actionResult:
    type: SetScanningIntervalActionResult
    upToDatePeriod: 28d
    obsoletePeriod: 56d
  state: inactive
  sourceType: system
  type: auditScanningInterval
  invalidReasons: null
  objectCount: 0
  objectCounts:
    type: PolicyObjectCounts
    assetsCount: 0
  description: Сроки актуальности данных будут указаны для всех активов средней значимости
  changeState: none
  warnings: []
  policyId: auditScanningInterval
  position: 1
  cli-mixin:
    mixin_ref_version: '2'
    kind: policy_rule
    timestamp: '2024-02-01 12:51:34.011481'
    product: 26.1.8760
    references_id:
    - id: 00000000-0000-0000-0000-000000000002
      kind: group
      hierarchy:
      - Root
```

В примере выше можно увидеть, что данные правила политики содержат в себе ссылки в виде ID на группы. При формировании информации CLI сохранит дополнительные свойства этих групп в "примеси" для возможности их определения в другой системе.

В качестве альтернативного пути, в случае необходимости выгрузить конкретное правило, можно использовать команду `mp policy rule`.

<div id='id_5_5_3'/>

### Работа с правилами политик

Правила являются отдельными сущностями внутри политик и опредляют их поведение. При этом список правил имеет определенный порядок, на основе которого эти правила обрабатываются. Если объект системы может быть изменен несколькими правилами, то будет применены условия первого по порядку правила.

Получить информацию о правиле политик:

```sh
# Получение информации о правиле политик в общем виде
mp policy rule <name | ID>
# Получение информации с использованием имени политики
mp policy rule Срок*
```

<div id='id_5_5_3_1'/>

#### Изменение положения правила в списке

Отдельный блок команд предназначен для изменения положения правила в списке политики:

```sh
# Повысить полождение правила
mp policy rule up <name | ID>
# Переместить правило в самый верх
mp policy rule top <name | ID>
# Понизить положение правила
mp policy rule down <name | ID>
# Переместить правило в самый низ
mp policy rule bottom <name | ID>
```

<div id='id_5_5_3_2'/>

#### Создание правил

> Зависимости: группы активов, наличие соответствующих политик.

Для того, чтобы правило было успешно создано, группы, которые применяются в правиле или правилах должны быть загружены в систему. При импорте правил, CLI попробует найти эти группы и если поиск будет неудачным, предложит их заменить.

```sh
# Запуск в режиме тестирования
import filename.yaml | mp policy rule create --disarm
# Импорт
import filename.yaml | mp policy rule create
```

<div id='id_5_5_3_3'/>

#### Удаление

Удалить правило или правила можно с помощью команды `delete`:
```sh
# Удаление правило name
mp policy rule delete <name>
# Удаление всех правил в политике
mp policy info <policy ID> | mp policy rule delete
# Запуск в тестовом режиме
mp policy rule delete <name> --disarm
```

<div id='id_5_6'/>

## Работа с отчетами

Отчеты в MaxPatrol формируются с помощью задач отчетов. Также, есть возможность создавать шаблоны отчетов.

> При работе с отчетами следует учитывать также текущий набор шаблонов виджетов доступных для пользователя в системе. Набор шаблонов не влияет на возможность импортировать или экспортировать отчеты и их шаблоны, однако воздействует на возможность создания новых отчетов

Работа с отчетами осуществляется с помощью поддерева `mp report`. Полная структура поддерева выглядит следующим образом:

```yaml
mp:
    report:
      task:
        create # Создание задачи отчета
        delete # Удаление
        info # Получение информации об отчете
        list # Получение списка
      template:
        create # Создание шаблона отчета
        delete # Удаление
        info # Получение информации об отчете
        list # Получение списка
```

<div id='id_5_6_1'/>

### Задачи отчетов

<div id='id_5_6_1_1'/>

#### Получение списка

Получить список задач можно с помощью команды `list`:

```sh
mp report task list
```
Пример структуры данных списка:
```yaml
- id: 19dc8748-1180-0001-0000-0000000000bb
  type: custom
  scheduleState: inactive
  lastIssueState: null
  name: Важные уязвимости, которые еще актуальны
  createdAt: '2024-01-30T07:35:43.2129760Z'
  modifiedAt: '2024-01-30T07:35:43.9928280Z'
  author:
    id: ea5d4afd-e352-4087-9c40-93d7ac0e6ac8
    name: Administrator
    email: null
    isActive: true
  isDeletable: true
  isLocked: false
  format: pdf
```
Данные списка содержат в себе только общую информацию о задаче выпуска отчетов. 

<div id='id_5_6_1_2'/>

#### Получение информации о задаче и выгрузка

Структура данных задачи отчета и отчета в целом представляет собой его набор данных, содержащий как описание структуры непосредственно отчета (форматирование, верстка и т.д.), так и блоков, входящих в этот отчет. При этом блоки являются самостоятельными сущностями с собственными идентификаторами, но для каждого отчета они являются оригинальными. При помощи команды `info` можно получить описание задачи отчета, при этом структура данных будет от части синтезирована CLI - по мимо "примеси" в струкутуре будет содержаться референсные описания блоков - `block_references`.

```sh
# Команда получения информации в общем виде
mp report task info <name | ID>
# Получение информации на основе списка
mp report task list | mp report task info
# Выгрузка спецификации задач отчетов
mp report task list | mp report task info | export filename.yaml
```
Пример структуры данных задачи отчета:
```yaml
- type: custom
  blocks:
  - id: 1252
  layout:
    defaultFont: Roboto
    reportHeader:
      enabled: false
      height: null
      htmlBody: ''
    reportFooter:
      enabled: false
      height: null
      htmlBody: ''
    showRunningTitlesForFirstPage: true
    isLandscape: false
  id: 19dc8748-1180-0001-0000-0000000000bb
  scheduleState: inactive
  lastIssueState: null
  name: Важные уязвимости, которые еще актуальны (копия) (копия)
  description: Отчет содержит список всех уязвимостей с отметкой «важная», которые
    еще не устранены, но и не исключены. На его основе вы можете создавать собственные
    шаблоны отчетов по отдельным группам активов, чтобы внедрить процесс управления
    уязвимостями в других сегментах инфраструктуры организации.
  createdAt: '2024-01-30T07:35:43.2129760Z'
  modifiedAt: '2024-01-30T07:35:43.9928280Z'
  author:
    id: ea5d4afd-e352-4087-9c40-93d7ac0e6ac8
    name: Administrator
    email: null
    isActive: true
  isDeletable: true
  isLocked: false
  format: pdf
  lastRunAt: null
  nextRunAt: null
  schedule:
    enabled: false
    utcOffset: +03:00
    periodicity: weekly
    days: []
    daysOfWeek:
    - monday
    firstFiredAt: null
    fireAt: 32400000
    repeatInterval: null
    enabledInterval: null
    scheduledInterval:
      from: '1000-12-30T23:59:59.0000000Z'
      to: '9999-12-30T23:59:59.0000000Z'
    delivery:
      email:
        enabled: true
        participants: []
        users: []
    recurrence: null
    recurrenceRange: null
    cronExpressions: null
  isSystem: false
  folderId: null
  block_references:
  - type: TextBlock
    data: '<p align="left" style="text-align: left; font-size: 12px; font-family:
      inherit;"><color style="color: rgb(77, 77, 77);"><strong><font-size style="font-size:
      28px;"><font-family style="font-family: Roboto;">Важные уязвимости, которые
      еще актуальны</font-family></font-size></strong></color></p>'
    dataMeta: '{"bottomOffset":0.4,"topOffset":0}'
    id: 1252
    version: 1
  cli-mixin:
    mixin_ref_version: '2'
    kind: report_task
    timestamp: '2024-02-02 09:02:46.316215'
    product: 26.1.8760
    references_id:
    - id: 00000000-0000-0000-0000-000000000002
      kind: group
      hierarchy:
      - Root
    - id: ea5d4afd-e352-4087-9c40-93d7ac0e6ac8
      kind: user
      user_login: null
```
В примере выше можно увидеть, что данные задачи отчета содержат в себе ссылки на другие сущности - группы, пользователи и запросы. При формировании информации CLI сохранит дополнительные свойства этих сущностей в "примеси" для возможности их определения в другой системе.

<div id='id_5_6_1_3'/>

#### Загрузка

> Зависимости: группы и запросы активов, пользователи.

Для того, чтобы загрузка спецификации задачи отчета прошла успешно, все сущности внутри его спецификации должны быть разрешены в ID, которые присутствуют в системе. Таким образом есть два основных варианта загрузки:

- Перед загрузкой задачи отчета или нескольких задач, осуществить импорт соответствующих запросов, групп и пользователей;
- Попытаться импортировать задачу отчета и преобразовать отсутствующие сущности.

```sh
# Запуск в режиме тестирования
import filename.yaml | mp report task create --disarm
# Импорт
import filename.yaml | mp report task create
```

<div id='id_5_6_1_4'/>

#### Удаление

Удалить задачу или задачи отчетов правила можно с помощью команды `delete`:
```sh
# Удаление задачи name
mp report task delete <name>
# Удаление всех задач
mp report task list | mp report task delete
# Запуск в тестовом режиме
mp report task delete <name> --disarm
```

<div id='id_5_6_2'/>

### Шаблоны отчетов

Основные отличия шаблонов от задач - отсутствие возможности выпуска и доступность для других пользователей. Информацию о структурах данных можно увидеть в задачах отчетов.

<div id='id_5_6_2_1'/>

#### Получение списка

В отличие от задач отчетов, в списке могут присутствовать шаблоны, встроенные в систему.
```sh
# Получение общего списка
mp report template list
# Получение только пользовательских шаблонов
mp report template list --user_only
```

<div id='id_5_6_2_2'/>

#### Получение информации о шаблоне и выгрузка

> Для того, чтобы иметь возможность получить информацию о шаблонах отчетов, в системе должна присутствовать по крайней мере одна задача на выпуск отчетов. Это связано с механизмом получения данных о блоках виджетов.

```sh
# Команда получения информации в общем виде
mp report template info <name | ID>
# Получение информации на основе списка
mp report template list | mp report task info
# Выгрузка спецификации пользовательских шаблонов отчетов
mp report template list --user_only | mp report template info | export filename.yaml
```

<div id='id_5_6_2_3'/>

#### Загрузка

> Зависимости: присутствие хотя бы одной задачи отчета, группы и запросы активов, пользователи.

```sh
# Запуск в режиме тестирования
import filename.yaml | mp report template create --disarm
# Импорт
import filename.yaml | mp report template create
```

<div id='id_5_6_2_4'/>

#### Удаление

Удалить шаблон или шаблоны отчетов можно с помощью команды `delete`:
```sh
# Удаление задачи name
mp report template delete <name>
# Удаление всех пользовательских задач
mp report template list --user_only | mp report template delete
# Запуск в тестовом режиме
mp report template delete <name> --disarm
```

<div id='id_5_7'/>

## Работа с площадками

Работа с площадками пока представлена только командой получения списка площадок.

```sh
mp site
```
Пример структуры данных списка площадок:
```yaml
- id: fc7dcff2-d30b-485b-9736-0c91f9d0446b
  name: Площадка
  alias: SITE
  address: 192.168.1.1
  isCurrent: true
  children: []
  syncError: false
  syncErrorType: null
  applications:
  - id: 19aab640-8140-0001-0000-000000000002
    alias: MC-1
    displayName: Management and Configuration
    endpoint: https://192.168.1.1:3334
    type: PTMC
    isHidden: false
  - id: 19ad5721-db80-0001-0000-000000000002
    alias: KB-1
    displayName: Knowledge Base
    endpoint: https://192.168.1.1:8091
    type: PT.PTKB
    isHidden: false
  - id: 19aabb3b-e600-0001-0000-000000000003
    alias: MP-1
    displayName: MaxPatrol 10
    endpoint: https://192.168.1.1/
    type: PT.MPSIEM
    isHidden: false
  tree_hierarchy:
  - Площадка
```

<div id='id_5_8'/>

## Работа с задачами

Задачи являются одним из ключевых механизмов работы MaxPatrol. С их помощью собирается различная информация об инфраструктуре и события. Также с работой задач связано множество сущностей.

Работа с задачами осуществляется с помощью поддерева `mp task`. Полная структура поддерева выглядит следующим образом:

```yaml
mp:
    task:
      create # Создание задачи
      credential:
        create # Создание учетной записи сканирования
        delete # Удаление
        info # Получение информации
        list # Получение списка
      delete # Удаление задачи
      dictionary:
        create # Создание списка
        delete # Удаление
        info # Получение информации о списке
        list # Получение списка
      history # История задачи
      info # Получение информации о задаче
      list # Получение списка задач
      profile:
        create # Создание профиля
        delete # Удаление
        info # Получение информации об профиле
        list # Получение списка
      start # Запуск задачи
      stop # Остановка задачи
      update # Изменение задачи
```
<div id='id_5_8_1'/>

### Получение списка

```sh
# Получение общего списка
mp task list
# Получение задач с проблемами выполнения
mp task list | select Lastrunerrorlevel!=green
```

Команда получает список задач MaxPatrol и представляет его в упрощенном табличном виде.

Пример структуры элемента списка:
```yaml
- id: 19c4ab01-bf80-0001-0000-000000000003
  name: API demo
  description: ''
  component: null
  agent:
    id: d4e2c74f-732d-4929-8d35-b07b3076f2ab
    name: 192.168.1.230
  scope:
    id: 00000000-0000-0000-0000-000000000005
    name: Инфраструктура по умолчанию
  profile:
    id: e27ac04f-95fb-41e0-ad0e-185b6713f08c
    name: HostDiscovery
  module:
    id: hostdiscovery
    name: hostdiscovery
  metatransports: []
  status: new
  created: '2024-01-11T18:48:15.2478457Z'
  lastRun: null
  nextRun: null
  lastRunErrorLevel: green
  include:
    assets: []
    targets:
    - 192.168.1.0/24
    assetsGroups: []
  exclude:
    assets: []
    targets: []
    assetsGroups: []
  isFqdnPriority: true
  validationState: valid
  lastRunError: null
  hostDiscovery:
    enabled: false
    profile: null
  hasBookmarks: false
  credentials: []
  triggerParameters:
    type: Daily
    atTime: 09:00:00
    timeZone: +03:00
    daysOfWeek:
    - monday
    - tuesday
    - wednesday
    - thursday
    - friday
    - saturday
    - sunday
    fromDate: null
    toDate: null
    isEnabled: false
```

Сама по себе эта структура данных содержит всю информацию по задаче, однако при формировании списка не выполняется действий по обработке сущностей, которые в нем содержатся. Список удобно использовать для различных выборок и контроля задач.

<div id='id_5_8_2'/>

### Получение информации о задаче и выгрузка

Структура задачи содержит в себе, пожалуй, самое большое количество ссылок в виде ID на другие сущности и, как следствие, зависимостей.

Обработкой этих зависимостей и сохранением информации, необходимой для переноса задачи в другую систему занимается команда `info`:

```sh
# Команда получения информации в общем виде
mp task info <name | ID>
# Получение информации на основе списка
mp task list | mp task info
# Выгрузка спецификации задач
mp task list | mp task info | export filename.yaml
```
Структура данных, получаемая в результате этой команды может отличаться от результатов команды `list` и будет содержать в себе "примесь".

> Важно: В некоторых случаях, задачи могут содержать в качестве указанных целей активы. Это означает, что при импорте такой задачи, ей будет необходим актив с таким ID. В случае, если CLI не сможет найти такой актив, будет предложен диалог с возможностью заменить его. Однако, вы можете воспользоваться ключем `--resolve_assets` для трансформации таких целей задачи в IP адреса по которым доступны активы. Следует учитывать, что подобные задачи будут нуждаться в ручной правке, для этого в примеси будет отражен протокол замены сущностей. Также, при выгрузке спецификации задачи CLI предупредит вас о наличии таких задач.

В некоторых случаях, задачи могут содержать неправильные ID сущностей, в результате чего получить информацию не получится. Чтобы обойти это, можно использовать ключ `--ignore_resolve`, однако наиболее вероятно, что без ручного вмешательства загрузить такие спецификации не получится.

<div id='id_5_8_3'/>

### Загрузка

> Зависимости: активы, учетные записи сканирования, коллекторы (AEC), профили задач, идентификаторы инфраструктуры, списки, группы активов.

Так как описание задач представляет собой структуры содержащие в себе большое количество зависимостей, загрузка таких спецификаций может быть сложной операцией. При импорте в "чужую" систему, чтобы избежать большого количества запросов на разрешение неизвестных сущностей, нужно сначала выполнить загрузку всех связанных спецификаций.

```sh
# Запуск в режиме тестирования
import filename.yaml | mp task create --disarm
# Импорт
import filename.yaml | mp task create
```

При миграции или переносе задач, может возникнуть ситуация, когда они должны быть перенесены _до того, как будут перенесены или настроены агенты_. В этом случае, разрешение ID агента может быть неудачным и загрузка будет неудачной. Чтобы временно назначить автоматического агента на задачи, можно использовать ключ `--drop_aec` и в последующем повторно их обновить для назначения правильных агентов.

 >Для некоторых задач, например модуля `syslog` создать задачу без назначения коллектора невозможно. В этом случае, будет возможность выбрать временный коллектор из уже существующих.

<div id='id_5_8_4'/>

### Изменение задачи

> Зависимости: активы, учетные записи сканирования, коллекторы (AEC), профили задач, идентификаторы инфраструктуры, списки, группы активов.

В спецификации существующих задач могут быть внесенены какие-либо изменения или вам может понадобится повторно применить спецификацию. В этом случае, вы можете воспользоваться командой `update`:

```sh
# Запуск в режиме тестирования
import filename.yaml | mp task update --disarm
# Импорт
import filename.yaml | mp task update
```
> Имя задачи является одним из основных признаков при применении спецификации. Поэтому, если необходимо при обновлении сменить имя задачи, нужно использовать ключ `--with_rename`, что позволит переименовать задачу.

<div id='id_5_8_5'/>

### Управление задачей

Запуск и остановка задач не является мгновенным процессом, поэтому команды запуска и остановки фактически только инициируют соответствующие действия для задачи.

```sh
# Тестовое применение
mp task start <name | ID> --disarm
# Запуск задачи
mp task start <name | ID>
# Приостановка задачи
mp task suspend <name | ID>
# Остановка задачи
mp task stop <name | ID>
```

<div id='id_5_8_6'/>

### История выполнения задач

Для получение краткой информации по истории запуска задач:

```sh
mp task history <name | ID>
```
Пример стуктуры записи в истории задачи:
```yaml
- id: 19d42bfc-6080-0001-0000-000000000002
  status: finished
  startedAt: '2024-01-23T19:48:59.3958942Z'
  finishedAt: '2024-01-23T19:49:34.7757603Z'
  jobCount: 1
  triggerType: manual
  startedBy:
    id: ea5d4afd-e352-4087-9c40-93d7ac0e6ac8
    login: Administrator
    firstName: null
    lastName: null
  stoppedBy: null
  errorStatus: green
```

<div id='id_5_8_7'/>

### Удаление

Удалить задачу или задачи можно с помощью команды `delete`:
```sh
# Удаление задачи name
mp task delete <name>
# Удаление всех задач
mp task delete | mp task delete
# Запуск в тестовом режиме
mp task delete <name> --disarm
```
<div id='id_5_8_8'/>

### Работа с учетными записями сканирования

Учетные записи сканирования в MaxPatrol бывают четырех видов: связка логин-пароль (LoginPassword), пароль (PasswordOnly), сертификат (Certificate) и LAPS (LapsProvider).

Работа с учетными записями задач сканирования осуществляется с помощью поддерева `mp task credential`. Полная структура поддерева выглядит следующим образом:

```yaml
mp:
    task:
      credential:
        create # Создание учетной записи сканирования
        delete # Удаление
        info # Получение информации
        list # Получение списка
```

<div id='id_5_8_8_1'/>

#### Получение списка и выгрузка

```sh
# Получение общего списка
mp task credential list
```

Команда получает список задач MaxPatrol и представляет его в упрощенном табличном виде.

Пример структуры элемента списка:
```yaml
- type: LoginPassword
  id: a9d4680d-96ad-4fc5-9c28-fc6441547c3d
  name: api
  description: ''
  credentialTags: []
  laps: null
```

Получить структуру учетной записи готовую к выгрузке, можно с помощью команды `info`:

```sh
# Команда в общем виде
mp task credential info <name | ID>
# Выгрузка всех учетных записей
mp task credential list | mp task credential info | export filename.yaml
```

>Обратите внимание, что секреты, которые содержатся в учетных записях не сохраняются в при выгрузке.

<div id='id_5_8_8_2'/>

#### Загрузка и удаление

> Зависимости: отсутствуют.

Так как в спецификациях отсутствуют секреты, при загрузке эти секреты будут заменены заглушками и, после создания учетных записей, вы должны восстановить секреты вручную. Исключением здесь является учетная запись сертификата - при импорте спецификации такого типа, вам будет нужно указать путь до файла с сертификатом.

```sh
# Запуск в режиме тестирования
import filename.yaml | mp task credential create --disarm
# Импорт
import filename.yaml | mp task credential create
```

Удалить учетную запись можно с помощью команды `delete`:
```sh
# Удаление учетной записи
mp task credential delete <name | ID>
# Удаление всех учетных записей
mp task credential list | mp task credential delete
# Запуск в тестовом режиме
mp task credential delete <name | ID> --disarm
```

<div id='id_5_8_9'/>

### Работа с профилями сканирования

Учетные записи сканирования в MaxPatrol бывают четырех видов: связка логин-пароль (LoginPassword), пароль (PasswordOnly), сертификат (Certificate) и LAPS (LapsProvider).

Работа с учетными записями задач сканирования осуществляется с помощью поддерева `mp task credential`. Полная структура поддерева выглядит следующим образом:

```yaml
mp:
    task:
      credential:
        create # Создание учетной записи сканирования
        delete # Удаление
        info # Получение информации
        list # Получение списка
```

<div id='id_5_8_9_1'/>

#### Получение списка и выгрузка

```sh
# Получение общего списка
mp task profile list
# Получение только пользовательских профилей
mp task profile list --user_only
```

Команда получает список профилей MaxPatrol и представляет его в упрощенном табличном виде.

Пример структуры элемента списка:
```yaml
- id: 983f02c4-1d9d-409b-be70-019b251f5ad2
  name: WinEventLog (PS+Sysmon)
  isSystem: false
  baseProfileName: WinEventLog
  moduleName: WinEventLog
  moduleId: wineventlog
  output: Events
  agentRequired: false
  baseProfileId: 33d9ff58-09f2-423e-a33e-eee18995a8b0
  validationErrors: []
```

Получить структуру профиля готовую к выгрузке, можно с помощью команды `info`:

```sh
# Команда в общем виде
mp task profile info <name | ID>
# Выгрузка всех пользовательских профилей
mp task profile list --user_only | mp task profile info | export filename.yaml
```

Пример структуры данных профиля:
```yaml
- id: 983f02c4-1d9d-409b-be70-019b251f5ad2
  name: WinEventLog (PS+Sysmon)
  output: Events
  description: ''
  isSystem: false
  moduleName: wineventlog
  moduleId: wineventlog
  baseProfileId: 33d9ff58-09f2-423e-a33e-eee18995a8b0
  baseProfileName: WinEventLog
  validationErrors: []
  profile:
    actualization_period: 600
    connection:
      auth_type: Negotiate
    event_buffer_size: 512
    inputs:
      '@GUID':
        description:
          expected_datetime_formats:
          - DATETIME_ISO8601
          - DATETIME_YYYYMMDD_HHMMSS
          time_delta: 0
          time_zone: 0
    log_channels:
      Application:
        select: '*'
        suppress: ''
      Microsoft-Windows-Dhcp-Client/Admin:
        select: '*'
        suppress: ''
      Microsoft-Windows-NetworkProfile/Operational:
        select: '*'
        suppress: ''
      Microsoft-Windows-PowerShell/Operational:
        select: '*[System[(EventID=4103 or EventID=4104)]]'
        suppress: ''
      Microsoft-Windows-PrintService/Operational:
        select: '*[System[(EventID=307)]]'
        suppress: ''
      Microsoft-Windows-TerminalServices-RemoteConnectionManager/Operational:
        select: '*'
        suppress: ''
      Microsoft-Windows-Windows Firewall With Advanced Security/Firewall:
        select: '*'
        suppress: ''
      Security:
        select: '*'
        suppress: ''
      System:
        select: '*'
        suppress: ''
    memory_settings:
      chunk_size: 1024
      max_allowed_memory: 256
      pre_allocated_memory: 16
    module_settings:
      historical: false
      keepalive_interval: 1000
      logging:
        ref_type: dictionary
        ref_value: logging_settings
      metric: true
      number_of_reconnects: 15
      pre_reconnect_delay: 60000
    new_events_only: true
    output_format: JSON
    result_package:
      package_quantity: 1000
      result_type: raw
      send_interval: 1000
  overrides:
    connection:
      auth:
        ref_type: credential
        ref_value: a9d4680d-96ad-4fc5-9c28-fc6441547c3d
    log_channels:
      Microsoft-Windows-PowerShell/Operational:
        select: '*'
      Microsoft-Windows-PrintService/Operational:
        select: '*'
      Microsoft-Windows-Sysmon/Operational:
        select: '*'
    module_settings:
      number_of_reconnects: 100
    result_package:
      package_quantity: 10
  cli-mixin:
    mixin_ref_version: '2'
    kind: profile
    timestamp: '2024-02-03 20:51:28.984688'
    product: 26.1.8760
    references_id:
    - id: a9d4680d-96ad-4fc5-9c28-fc6441547c3d
      kind: credential
      name: win
    - id: 33d9ff58-09f2-423e-a33e-eee18995a8b0
      kind: profile
      name: WinEventLog
```

Характерной особенностью пользовательских профилей является наличие ссылки на базовый профиль в виде ID. Эти идентфикаторы, а также другие сущености будут отражены в "примеси" для успешной загрузки в "чужую" систему.

<div id='id_5_8_9_2'/>

#### Загрузка и удаление

> Зависимости: профили сканирования, учетные записи сканирования, списки.

```sh
# Запуск в режиме тестирования
import filename.yaml | mp task profile create --disarm
# Импорт
import filename.yaml | mp task profile create
```

Удалить профиль можно с помощью команды `delete`:
```sh
# Удаление профиля
mp task profile delete <name | ID>
# Удаление всех пользовательских профилей
mp task profile list --user_only | mp task profile delete
# Запуск в тестовом режиме
mp task profile delete <name | ID> --disarm
```

<div id='id_5_9'/>

## Работа с шаблонами виджетов

В MaxPatrol шаблоны виджетов применяются для формирования страниц (дашбордов) и отчетов.

Работа с шаблонами виджетов осуществляется с помощью поддерева `mp template`. Полная структура поддерева выглядит следующим образом:

```yaml
mp:
    template:
      create # Создание шаблона
      delete # Удаление
      info # Получение информации об шаблоне
      list # Получение списка
```

<div id='id_5_9_1'/>

#### Получение списка и выгрузка

```sh
# Получение общего списка
mp template list
# Получение только пользовательских шаблонов
mp template list --user_only
```

Команда получает список шаблонов MaxPatrol и представляет его в упрощенном табличном виде.

Пример структуры элемента списка:
```yaml
- id: 11
  system: true
  source:
  - assets
  name: Трендовые уязвимости
  type: vmWidgetTrendVulnerabilities
```

Получить структуру шаблона готовую к выгрузке, можно с помощью команды `info`:

```sh
# Команда в общем виде
mp template info <name | ID>
# Выгрузка всех пользовательских шаблонов
mp template list --user_only | mp template info | export filename.yaml
```

Пример структуры данных шаблона:
```yaml
- type: WidgetByDataFilter
  filter:
    type: stored
    id: a7dd0df1827c4e8ba0d497dca752ffb5
    timeInterval:
      value:
        period: now
        fixedFrom: null
        fixedTill: null
      valueV2: null
    groups:
      recursive: true
      value:
      - 00000000-0000-0000-0000-000000000002
    refresh: null
  source:
  - assets
  systemTemplateId: null
  name: ФСТЭК
  settings:
    type: settings
    title:
      showName: true
      showData:
        enabled: true
        showSource: true
        showPeriod: true
        showGroups: true
        showFilter: true
    body: null
    subtitle: null
    links:
      point: null
      element: element
    dimension:
      name: name
    autoSeries:
      name: name
    series:
    - name: null
      measure:
        name: name
      selectedOrder: none
      seriesType: none
    chart:
      legend: null
      xAxis: null
      yAxis: null
      plotOptions: null
      tooltip: null
    drilldown: null
    table:
      type: table
  layoutType: ptTable
  refreshCachingPolicy:
    type: periodical
    interval:
      value: 1h
  id: 35
  version: 1
  system: false
  layoutSettings:
    index: 0
    styleClass: null
  dataMeta: null
  cli-mixin:
    mixin_ref_version: '2'
    kind: template
    timestamp: '2024-02-03 21:30:24.583784'
    product: 26.1.8760
    references_id:
    - id: 00000000-0000-0000-0000-000000000002
      kind: group
      hierarchy:
      - Root
    - id: a7dd0df1827c4e8ba0d497dca752ffb5
      kind: query
      hierarchy:
      - Общие запросы
      - 3. Уязвимости на активах
      - Расчет критичности уязвимостей (вся компания)
```

<div id='id_5_9_2'/>

#### Загрузка и удаление

> Зависимости: группы и запросы активов.

```sh
# Запуск в режиме тестирования
import filename.yaml | mp template create --disarm
# Импорт
import filename.yaml | mp template create
```

Удалить шаблон можно с помощью команды `delete`:
```sh
# Удаление шаблона
mp template delete <name | ID>
# Удаление всех пользовательских профилей
mp template list --user_only | mp template delete
# Запуск в тестовом режиме
mp template delete <name | ID> --disarm
```

<div id='id_5_10'/>

## Работа с пользователями

Работа с пользователями в MaxPatrol находится в зоне функциональности компонента Management and Configuration. Модель разрешений пользователя описывается ролями, а роли, в свою очередь назначаются конкретным пользователям.

В CLI работа с пользователями осуществляется с помощью поддерева `mp user`. Полная структура поддерева выглядит следующим образом:

```yaml
mp:
    user:
      create # Создание пользователя
      info # Получение информации о пользователе
      list # Получение списка пользователей
      log # Получение журнала действий
      privilege # Получение привилегий пользователя
      role:
        list # Список ролей пользователей
        privilege # Получение привилегий для роли или ролей
        create # Создание роли
        delete # Удаление роли
```

<div id='id_5_10_1'/>

### Сущности пользователей

```sh
# Получение списка пользователей
mp user list
```
Пример структуры данных объекта списка:
```yaml
- id: ea12bca3-7eb3-4cad-aad3-e154455f492f
  userName: api_demo
  firstName: Иван
  lastName: Иванов
  middleName: Иванович
  email: ivan@ivan.ru
  status: blocked
  phone: '+700000000'
  isReadOnly: false
  siteId: fc7dcff2-d30b-485b-9736-0c91f9d0446b
  authType: 0
  ldapAliases:
  - ''
  roles: []
  ldapSyncEnabled: false
  ldapRolesSyncEnabled: false
  system: false
```

Данная информация является общей и не содержит в себе описания назначеных ролей и, соответственно привилегий прользователя. Вы можете быстро получить список назначенных на пользователя привилегий с помощью команды `privilege`:

```sh
mp user privilege <name | ID>
```

Пример структуры информации о привилегиях:
```yaml
- id: ea12bca3-7eb3-4cad-aad3-e154455f492f
  userName: api_demo
  fullName: Иванов Иван Иванович
  privileges:
  - id: 95e5a847-ef1e-4afd-9ea4-cef5d115b6b4
    application: idmgr
    name: Пользователь
    privileges:
    - Иерархия площадок->Просмотр иерархии площадок
    - Профиль пользователя->Изменение контактной информации
    - Профиль пользователя->Изменение организационной информации
    - Профиль пользователя->Смена фамилии, имени и отчества
    - Роли->Просмотр списка ролей
    - Связи приложений->Просмотр правил репликации и связей для распределенного поиска
```

Данная команда несет в себе исключительно информативную функцию.

Помимо просмотра привилегий пользователей, вы также можете получить журнал действий всех пользователей или какого-либо пользователя конкретно:

```sh
# Получение журнала действий за последний час, с лимитом 15 записей
mp user log [name | ID]
# Получение журнала записей, начиная с определенного времени
mp user log --time_from=YYYY-MM-DDThh:mm --limit=50
```

Пример структуры события журнала:
```yaml
- id: 98e4af8d-1e92-4a2c-83ce-98d87d5f868d
  beginDateTime: '2024-02-04T08:52:52.6361660Z'
  beginTime: 1707036772
  beginUtcOffset: +00:00
  duration: '00:00:00.0045260'
  userId: ea5d4afd-e352-4087-9c40-93d7ac0e6ac8
  userLogin: Administrator
  userDomain: null
  objectDomainId: 8ddb7508-7fa9-473b-8def-64efc0ddf684
  objectDomain: Управление системой
  objectTypeId: 3925857c-9745-4f22-ba24-47aff72306bd
  objectType: Пользователь
  objectId: ea5d4afd-e352-4087-9c40-93d7ac0e6ac8
  objectDisplayName: Administrator (SITE)
  applicationId: 19aab640-8140-0001-0000-000000000002
  applicationName: Management and Configuration
  code: Чтение
  result: Success
  failReason: null
  details: null
  additionalFields:
    RemoteIpAddress: 192.168.1.1
```

Чтобы получить информацию о пользователе в системе и сохранить ее в спецификацию, необходимо использовать команду `info`:

```sh
# Команда получения информации о пользователе в общем виде
mp user info <name | ID>
# Сохранение спецификаций несистемных пользователей
mp user list | select system!=true | mp user info | export filename.yaml
# Сохранение спецификаций несистемных и активных пользователей
mp user list | select system!=true and status!=blocked | mp user info | export filename.yaml
```

Пример структуры данных информации о пользователе:
```yaml
- position: Позиция
  manager: Руководитель
  department: Департамент
  roles:
  - applicationId: idmgr
    tenantId: 00000000-0000-0000-0000-000000000000
    roleId: 95e5a847-ef1e-4afd-9ea4-cef5d115b6b4
    clientRoleId: null
    roleName: Пользователь
    applicationName: Management and Configuration
  id: 321f8526-1179-40ea-8a43-650b80afc2ae
  userName: api_demo
  firstName: Иван
  lastName: Иванов
  middleName: Иванович
  email: ivan@ivan.ru
  status: active
  phone: '+700000000'
  isReadOnly: false
  siteId: fc7dcff2-d30b-485b-9736-0c91f9d0446b
  authType: 0
  ldapAliases:
  - ''
  ldapSyncEnabled: false
  ldapRolesSyncEnabled: false
  system: false
  cli-mixin:
    mixin_ref_version: '2'
    kind: user
    timestamp: '2024-02-04 10:59:18.970097'
    product: 26.1.8760
    references_id:
    - id: 00000000-0000-0000-0000-000000000000
      kind: ignore
    - id: 95e5a847-ef1e-4afd-9ea4-cef5d115b6b4
      kind: user_role
      application: idmgr
      name: Пользователь
    - id: fc7dcff2-d30b-485b-9736-0c91f9d0446b
      kind: site
      hierarchy:
      - Площадка
```
Как видно из спецификации выше, сущность пользователя может зависеть от площадки и назначенных ему пользовательских ролей.

Создать пользователя или нескольких пользователей из спецификации можно с помощью команды `create`:

> Зависимости: площадки, приложения, роли пользователей

```sh
import filename.yaml | mp user create
# Запуск в тестовом режиме
import filename.yaml | mp user create --disarm
```

> Обратите внимание: на данный момент удалить пользователей из системы невозможно

Пользователи будут созданы в заблокированном виде с установленным паролем-заглушкой.

<div id='id_5_10_2'/>

### Роли пользователей

Роли Management and Configuration описывают наборы разрешений (действий) в системе. В MC уже присутствуют обязательные системные роли, также можно создать свои собственные наборы разрешений. Роли индивидуальны для каждого приложения (`MPX`, `IDMGR`, `PTKB`).

Получить список ролей можно с помощью команды `list`:

```sh
# Получение общего списка
mp user role list
# Получение только пользовательских ролей
mp user role list | select type==custom | fmt table
# Получение ролей для определенного приложения
mp user role list | select application==mpx | fmt table
```

Пример структуры данных списка:
```yaml
- id: e380de87-21b9-4251-8ab3-fb968a310932
  name: API Demo
  description: ''
  privileges:
  - GetContentDatabaseTopRevision
  - RemoveContentDatabase
  - RemoveRootContentDatabase
  - CreateContentDatabaseChild
  - SetIsUpdatable
  - MergeContentDatabase
  - RevertChanges
  - SetIsDeployable
  - CreateRootDatabases
  - UploadUpdates
  - PullToContentDatabase
  type: Custom
  application: ptkb
  cli-mixin:
    mixin_ref_version: '2'
    kind: user_role
    timestamp: '2024-02-04 12:45:33.454643'
    product: 26.1.8760
```

Так как в данном случае `list` является основой спецификации, в PIPE выдаются данные в формате YAML. Чтобы получить их снова в табличном виде, нужно добавлять `fmt table`.

```sh
# Создание спецификаций пользовательских ролей
mp user role list | select type==custom | export filename.yaml
```

Также как и для пользователей, можно быстро получить список привилегий для роли:

```sh
mp user role privilege <name | ID>
```
Создать роль пользователя или несколько из спецификации можно с помощью команды `create`:

> Зависимости: приложения

```sh
import filename.yaml | mp user role create
# Запуск в тестовом режиме
import filename.yaml | mp user role create --disarm
```

<div id='id_5_11'/>

## Перенос сущностей между разными системами

Фактически перенос сущностей (учетных записей, пользовательский профилей сканирования, групп, задач сканирования и т.д.) означает их корректное пересоздание в новой системе. Сами сущности могут содержать идентификаторы других сущностей (ID) в различных видах.

>Порядок в котором осуществляется создание сущностей в целевой системе является очень важным. Будьте внимательны.

<div id='id_5_11_1'/>

### Создание спецификаций

Первым шагом в подготовке к переносу является создание спецификаций учетных записей сканирования из исходной системы:

```sh
mp task credential list | mp task credential info | export source_creds.yaml
```

> Обратите внимание, что в спецификациях отсутствуют секреты и сертификаты. Важный момент, что в MaxPatrol нельзя создать учетную запись (credential) с сертификатом без сертификата и при попытке создания такой сущности, скрипт спросит путь до сертификата. Вы можете его не указывать, однако в этом случае, **учетная запись создана не будет и ее надо будет создать вручную**. Остальные виды учетных записей будут созданы, но будут содержать в себе секреты - заглушки. На этапе переноса это не принципиально, но **для нормальной работы секреты надо будет указать вручную.**

Вторым шагом экспортируем пользовательские профили сканирования. 

```sh
mp task profile list | select Issystem!=True | mp task profile info | export source_profiles.yaml
```

В некоторых случаях, пользовательские профили могут содержать ( или не содержать вообще ) неверные учетные записи. В этом случае, экспорт не получится и скрипт отразит эти ошибки:

```sh
Completed with following problems:
┌──────────────────────────────────────┬───────────────────────────────┐
│ Profile                              │ Problem                       │
├──────────────────────────────────────┼───────────────────────────────┤
│ 9c6d6543-b784-4311-a5d8-3bd6b5c9bfbc │ Credential ID(s) not resolved │
└──────────────────────────────────────┴───────────────────────────────┘
```

Данные профили также будут помечены как ошибочные в UI.
Тем не менее, для того чтобы получить спецификацию данных профилей можно применить ключ `--ignore_resolve`.

> Спецификации полученные с `--ignore_resolve` не могут быть импортированы в новую систему без модификации

Также, в случае переноса учетных записей пользователей, необходимо сначала выгрузить пользовательские роли:

```sh
mp user role list | select type==custom | export source_user_roles.yaml
```

Сохранение спецификаций пользователей:

```sh
mp user list | select system!=true | mp user info | export source_users.yaml
```

Далее, нужно выгрузить группы активов:

```sh
mp asset group list | mp asset group info | export source_groups.yaml
```

> В MaxPatrol членство в статических группах хранится в самих активах. Таким образом, следует помнить, что членство в статических группах перенесено не будет и это придется сделать вручную или перенести соответствующие активы.

Также, можно выгрузить запросы, которые были созданы в системе:

```sh
mp asset query list | mp asset query info --user_only | export source_queries.yaml
```

Помимо прочего, задачи могут ссылаться на различные справочники, как системные, так и пользовательские. Для того, чтобы сохранить пользовательские справочники используем:

```sh
mp task dictionary list | select issystem!=True | mp task dictionary info | export source_dictionaries.yaml
```

Выгрузка задач осуществляется следующим образом.

```sh
mp task list | mp task info | export source_tasks.yaml
```

Однако, есть момент, что в задачах могут содержаться цели ( targets ) в виде конкретных активов. Если в новую систему в момент импорта такой спецификации активы уже перенесены, то скрипт попытается разрешить имена активов в новые идентификаторы ID и использовать их.

Если импорт задач в новую систему будет осуществляться до переноса активов или по каким-то причинам активы переноситься не будут, то необходимо разрешить такие цели в IP/FQDN.

```sh
mp task list | mp task info --resolve_assets | export source_tasks_resolved.yaml
```

В "примеси" ( mixin ) спецификации скрипт отметит те активы, которые были разрешены в IP/FQDN:

```sh
  cli-mixin:
    mixin_ref_version: '1'
    kind: task
    timestamp: '2023-11-15 20:29:27.095475'
    resolved: true
    asset_targets: true
    asset_targets_resolved: true
    asset_targets_info:
      include:
      - name: 192.168.1.128
        id: 195ebc1c-afc0-0001-0000-000000000009
        resolved_to: 192.168.1.128
      - name: 192.168.1.133
        id: 195ebf42-75c0-0001-0000-00000000000e
        resolved_to: 192.168.1.133
      exclude: []
```

Сделано это с целью последующего ручного восстановления правильного состояния целей ( оставлять цели в IP/FQDN может быть некорректным ).

Также как и задачи, политики зависят от остальных сущностей. Их спецификации можно сделать с помощью команды:

```sh
mp policy list | mp policy info | select sourcetype==user | export source_policies.yaml
```

Выгружаем шаблоны виджетов:

```sh
mp template list --user_only | mp template info | export source_templates.yaml
```

Выгружаем дашборды - выбираем необходимые для переноса дашборды с помощью `mp dashboard list` и выгружаем их:

```sh
mp dashboard list | select id==171 or id==186 | mp dashboard info | export source_dashboards.yaml
```
При необходимости, сохраняем пользовательские шаблоны отчетов и отчеты:

```sh
mp report template list --user_only | mp report template info | export source_report_templates.yaml
mp report task list --user_only | mp report task info | export source_reports.yaml
```
<div id='id_5_11_2'/>

### Загрузка спецификаций

Создание сущностей требует режим `enable`. Также, протестировать ( частично ) создание можно, используя ключи `--disarm`.

Начинать импорт следует с создания учетных записей сканирования:

```sh
enable
import source_creds.yaml | mp task credential create
```

> Если по каким-либо причинам какая-то из спецификаций учетных записей пропущена, с этой проблемой нужно разобраться на данном этапе, так как в последующем, это может вызвать ошибки создания других сущностей

Далее, импортируем пользовательские профили сканирования:

```sh
import source_profiles.yaml | mp task profile create
```

> Аналогично, очень важно, чтобы все пользовательские профили были созданы в целевой системе

Импортируем пользовательские роли:

```sh
import source_user_roles.yaml | mp user role create
```

Импортируем пользователей:

```sh
import source_users.yaml | mp user create
```

Импортируем группы:

```sh
import source_groups.yaml | mp asset group create
```

> Структура групп должна быть создана полностью, за исключением встроенных

Импортируем запросы:

```sh
import source_queries.yaml | mp asset query create
```

Добавляем справочники:

```sh
import source_dictionaries.yaml | mp task dictionary create
```

И наконец, импортируем задачи:

```sh
import source_tasks_resolved.yaml | mp task create
```

В ходе переноса данных, может возникнуть ситуация, когда в целевой системе еще отсутствуют агенты, которые указаны в спецификациях задач. В этом случае создание таких задач завершится ошибкой. Для того чтобы импортировать задачи и временно задать им автоматический выбор агента можно использовать ключ `--drop_aec`:

```sh
import source_tasks_resolved.yaml | mp task create --drop_aec
```

> Некоторые виды задач, например `Syslog` не могут быть созданы без указания агента. В этом случае, будет выведена ошибка создания и скрипт попросит выбрать агента из списка имеющихся в системе

После того, как агенты появятся в целевой системе со старыми именами, можно обновить задачи теми же спецификациями:

```sh
import source_tasks_resolved.yaml | mp task update
```

Импорт правил политик также осуществляется в конце:

```sh
import source_policies.yaml | mp policy create
```

Импортируем виджеты:

```sh
import source_templates.yaml | mp template create
```

Импортируем дашборды:

```sh
import source_dashboards.yaml | mp dashboard create
```

Импортируем шаблоны отчетов и задачи отчетов:

```sh
import source_report_templates.yaml | mp report template create
import source_reports.yaml | mp report task create
```

Чтобы процесс импорта был удобнее, можно использовать общую команду импорта:

```sh
mp import source*.yaml
```

Скрипт прочитает все файлы спецификаций, определит их тип и выполнит создание сущностей в нужном порядке. Также эту команду можно использовать для импорта спецификаций всех типов.
